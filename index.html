// === 儲存單日紀錄 ===
async function saveDailyRecord() {
    const date = recordDateInput.value;
    const distance = parseFloat(dailyDistanceInput.value);
    const efficiency = parseFloat(fuelEfficiencyInput.value);
    const costPerLiter = parseFloat(fuelCostPerLiterInput.value);
    const name = recordNameInput.value.trim();

    if (!date || !distance || !efficiency || !costPerLiter || !name) {
        alert('請完整輸入所有欄位');
        return;
    }

    const fuelUsed = distance / efficiency;
    const totalCost = fuelUsed * costPerLiter;

    const { error } = await supabaseClient
        .from(TABLE_NAME)
        .insert([{
            date,
            distance,
            efficiency,
            costPerLiter,
            name,
            fuelUsed,
            totalCost
        }]);

    if (error) {
        console.error('Error saving record:', error.message);
        alert('儲存失敗');
        return;
    }

    alert('已儲存紀錄');
    fetchAndRenderRecords();

    // 清空欄位（避免殘留）
    recordNameInput.value = "";
    dailyDistanceInput.value = "";
    dailyResult.innerHTML = "";
}

// === 渲染所有紀錄 ===
async function fetchAndRenderRecords(filterText = '') {
    const { data, error } = await supabaseClient
        .from(TABLE_NAME)
        .select('*')
        .order('date', { ascending: false });

    if (error) {
        console.error('Error fetching records:', error.message);
        return;
    }

    const filtered = data.filter(r =>
        r.name.includes(filterText) || r.date.includes(filterText)
    );

    recordsList.innerHTML = '';
    filtered.forEach(record => {
        const div = document.createElement('div');
        div.className = 'record-item';
        div.innerHTML = `
            <strong>${record.date}</strong> - ${record.name} - ${record.distance} km,
            ${record.fuelUsed.toFixed(2)} L, $${record.totalCost.toFixed(2)}
            <button class="delete-btn" data-id="${record.id}">刪除</button>
        `;
        recordsList.appendChild(div);
    });
}

// === 刪除單筆紀錄 ===
async function deleteSingleRecord(id) {
    const { error } = await supabaseClient
        .from(TABLE_NAME)
        .delete()
        .eq('id', id);

    if (error) {
        console.error('Error deleting record:', error.message);
        return;
    }

    fetchAndRenderRecords();
}

// === 點擊刪除按鈕（事件委派） ===
recordsList.addEventListener('click', e => {
    if (e.target.classList.contains('delete-btn')) {
        const id = e.target.dataset.id;
        deleteSingleRecord(id);
    }
});
